name: trackly
services:
  db:
    platform: linux/amd64
    container_name: trackly_db
    image: imresamu/postgis:alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-trackly}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      # only for development, debugging, and testing, do not expose in production
      - 5432:5432
    volumes:
      - ./db_data:/var/lib/postgresql
    healthcheck:
      test: [ "CMD", "pg_isready", "-U", "${POSTGRES_USER}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
  backend:
    container_name: trackly_backend
    restart: unless-stopped
    build: ./backend
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-trackly}
      RUST_LOG: trace # info | debug | trace
      MAX_HTTP_BODY_SIZE: ${MAX_HTTP_BODY_SIZE:-52428800}
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-50331648}
      UPLOAD_RATE_LIMIT_SECONDS: ${UPLOAD_RATE_LIMIT_SECONDS:-10}
      SERVICE_NAME: trackly_backend
      APP_ENV: dev
      SITE_URL: ${SITE_URL:-http://localhost:8080}
      DATABASE_MAX_CONNECTIONS: ${DATABASE_MAX_CONNECTIONS:-5}
      TRACK_MAX_GAP_METERS: ${TRACK_MAX_GAP_METERS:-500}
      TRACK_LIST_SIMPLIFY_MIN_POINTS: ${TRACK_LIST_SIMPLIFY_MIN_POINTS:-1000}
      TRACK_LIST_SIMPLIFY_MIN_RETENTION: ${TRACK_LIST_SIMPLIFY_MIN_RETENTION:-0.5}
      TRACK_SIMPLIFY_MIN_RATIO: ${TRACK_SIMPLIFY_MIN_RATIO:-0.01}
      TRACK_SIMPLIFY_MIN_POINTS: ${TRACK_SIMPLIFY_MIN_POINTS:-500}
      TRACK_SIMPLIFY_REFINE_ITERATIONS: ${TRACK_SIMPLIFY_REFINE_ITERATIONS:-4}
      SLOPE_ELEVATION_SMOOTHING_WINDOW: ${SLOPE_ELEVATION_SMOOTHING_WINDOW:-50.0}
      SLOPE_CALCULATION_WINDOW: ${SLOPE_CALCULATION_WINDOW:-25.0}
      ENRICHMENT_QUEUE_CAPACITY: ${ENRICHMENT_QUEUE_CAPACITY:-128}
    depends_on:
      - db
    ports:
      - 8080:8080
    healthcheck:
      test: [ "CMD", "/app/backend", "--health-check" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  frontend:
    container_name: trackly_frontend
    restart: unless-stopped
    build: ./frontend
    environment:
      # Use SITE_URL (set for backend) as default; can override VITE_SITE_URL for frontend
      VITE_SITE_URL: ${VITE_SITE_URL:-${SITE_URL:-http://localhost:90}}
    volumes:
      - ./frontend/Caddyfile:/etc/caddy/Caddyfile
    ports:
      - 90:80
      - 444:443
      - 2019:2019 # expose Caddy admin API for Prometheus metrics
    depends_on:
      - backend
