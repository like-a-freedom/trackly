{
	metrics
	admin :2019
	# Disable automatic HTTPS since we're behind a proxy
	auto_https off
}
localhost { # use real domain in production
    tls internal

    # Security headers - centralized at reverse proxy level
    header {
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: https://*.openstreetmap.org https://*.tile.openstreetmap.org; connect-src 'self'; font-src 'self' https://unpkg.com"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        X-XSS-Protection "1; mode=block"
        -Server
    }

	# API routes - proxy to backend
	handle /api/* {
		uri strip_prefix /api
		reverse_proxy backend:8080 {
			flush_interval -1
			header_up X-Real-IP {http.request.header.X-Real-IP}
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
			header_up X-Forwarded-Proto {http.request.header.X-Forwarded-Proto}
		}
	}

	# Legacy direct API routes
	handle /tracks* {
		reverse_proxy backend:8080 {
			flush_interval -1
			header_up X-Real-IP {http.request.header.X-Real-IP}
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
			header_up X-Forwarded-Proto {http.request.header.X-Forwarded-Proto}
		}
	}

	# Health check
	handle /health {
		reverse_proxy backend:8080
	}

	# Serve frontend static files
	handle {
		root * /usr/share/caddy
		file_server
		try_files {path} /index.html
	}
}