groups:
  - name: trackly_product_recording_rules
    interval: 1m
    rules:
      - record: engagement_score_7d
        expr: |
          sum by (session_hash) (
            10 * increase(trackly_session_heartbeat{activity="upload"}[7d]) +
            2 * increase(trackly_session_heartbeat{activity="view"}[7d]) +
            10 * increase(trackly_session_heartbeat{activity="enrich"}[7d]) +
            5 * increase(trackly_session_heartbeat{activity="edit"}[7d]) +
            5 * increase(trackly_session_heartbeat{activity="search"}[7d]) +
            5 * increase(trackly_session_heartbeat{activity="export"}[7d])
          )
      - record: sessions_active_1d
        expr: |
          count((sum by (session_hash) (count_over_time(trackly_session_heartbeat[1d]))) > 0)
      - record: sessions_active_7d
        expr: |
          count((sum by (session_hash) (count_over_time(trackly_session_heartbeat[7d]))) > 0)
      - record: sessions_active_30d
        expr: |
          count((sum by (session_hash) (count_over_time(trackly_session_heartbeat[30d]))) > 0)
      - record: sessions_churn_risk
        expr: |
          count(
            sum by (session_hash) (count_over_time(trackly_session_heartbeat[30d]))
            unless
            sum by (session_hash) (count_over_time(trackly_session_heartbeat[14d]))
          )
      - record: sessions_churn_rate
        expr: |
          sessions_churn_risk / sessions_active_30d
      - record: funnel_uploads_7d
        expr: |
          sum(increase(tracks_uploaded_total[7d]))
      - record: funnel_views_7d
        expr: |
          sum(increase(track_views_total[7d]))
      - record: funnel_enrich_success_7d
        expr: |
          sum(increase(track_enrich_requests_total{status="success"}[7d]))
      - record: funnel_exports_7d
        expr: |
          sum(increase(track_exports_total[7d]))
      - record: funnel_edits_7d
        expr: |
          sum(increase(track_edits_total[7d]))
      - record: funnel_deletes_7d
        expr: |
          sum(increase(tracks_deleted_total{result="success"}[7d]))
      - record: zero_result_rate_7d
        expr: |
          sum(increase(track_searches_total{result_type="zero"}[7d])) / sum(increase(track_searches_total[7d]))
      - record: retention_d1
        expr: |
          count(
            sum by (session_hash) (count_over_time(trackly_session_heartbeat[1d] offset 1d))
            and
            sum by (session_hash) (count_over_time(trackly_session_heartbeat[1d]))
          )
          /
          count(sum by (session_hash) (count_over_time(trackly_session_heartbeat[1d] offset 1d)))
      - record: retention_d7
        expr: |
          count(
            sum by (session_hash) (count_over_time(trackly_session_heartbeat[7d] offset 7d))
            and
            sum by (session_hash) (count_over_time(trackly_session_heartbeat[7d]))
          )
          /
          count(sum by (session_hash) (count_over_time(trackly_session_heartbeat[7d] offset 7d)))
      - record: retention_d30
        expr: |
          count(
            sum by (session_hash) (count_over_time(trackly_session_heartbeat[30d] offset 30d))
            and
            sum by (session_hash) (count_over_time(trackly_session_heartbeat[30d]))
          )
          /
          count(sum by (session_hash) (count_over_time(trackly_session_heartbeat[30d] offset 30d)))

      # Engagement segments (passive/active/power) derived from engagement_score_7d
      - record: engagement_segment_passive
        expr: |
          count(engagement_score_7d < 21)
      - record: engagement_segment_active
        expr: |
          count(engagement_score_7d >= 21 and engagement_score_7d <= 50)
      - record: engagement_segment_power
        expr: |
          count(engagement_score_7d > 50)

      # New sessions approximation: sessions active in 1d but not in previous 30d window
      - record: new_sessions_1d_approx
        expr: |
          count(
            sum by (session_hash) (count_over_time(trackly_session_heartbeat[1d]))
            unless
            sum by (session_hash) (count_over_time(trackly_session_heartbeat[30d] offset 1d))
          )
