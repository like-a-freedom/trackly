{
    "id": null,
    "uid": "postgres-health",
    "title": "PostgreSQL Health",
    "schemaVersion": 39,
    "version": 1,
    "tags": [
        "postgres"
    ],
    "templating": {
        "list": [
            {
                "name": "env",
                "type": "query",
                "query": "label_values(env)",
                "current": {
                    "text": "prod",
                    "value": "prod"
                }
            },
            {
                "name": "instance",
                "type": "query",
                "query": "label_values(pg_up, instance)",
                "includeAll": true
            }
        ]
    },
    "panels": [
        {
            "type": "stat",
            "title": "Connections",
            "targets": [
                {
                    "expr": "sum(pg_stat_activity_count{instance=~\"$instance\"})"
                }
            ]
        },
        {
            "type": "graph",
            "title": "Connections vs Max",
            "targets": [
                {
                    "expr": "sum(pg_stat_activity_count{instance=~\"$instance\"})"
                },
                {
                    "expr": "sum(pg_settings_max_connections{instance=~\"$instance\"})"
                }
            ]
        },
        {
            "type": "graph",
            "title": "Cache Hit Ratio",
            "targets": [
                {
                    "expr": "sum(rate(pg_stat_database_blks_hit{instance=~\"$instance\"}[5m])) / (sum(rate(pg_stat_database_blks_hit{instance=~\"$instance\"}[5m])) + sum(rate(pg_stat_database_blks_read{instance=~\"$instance\"}[5m])))"
                }
            ]
        },
        {
            "type": "graph",
            "title": "Tuples Operations",
            "targets": [
                {
                    "expr": "sum(rate(pg_stat_database_tup_returned{instance=~\"$instance\"}[5m]))"
                },
                {
                    "expr": "sum(rate(pg_stat_database_tup_fetched{instance=~\"$instance\"}[5m]))"
                },
                {
                    "expr": "sum(rate(pg_stat_database_tup_inserted{instance=~\"$instance\"}[5m]))"
                },
                {
                    "expr": "sum(rate(pg_stat_database_tup_updated{instance=~\"$instance\"}[5m]))"
                },
                {
                    "expr": "sum(rate(pg_stat_database_tup_deleted{instance=~\"$instance\"}[5m]))"
                }
            ]
        },
        {
            "type": "graph",
            "title": "Locks",
            "targets": [
                {
                    "expr": "sum by(mode) (pg_locks_count{instance=~\"$instance\"})"
                }
            ]
        },
        {
            "type": "graph",
            "title": "Deadlocks",
            "targets": [
                {
                    "expr": "sum(rate(pg_stat_database_deadlocks{instance=~\"$instance\"}[5m]))"
                }
            ]
        },
        {
            "type": "graph",
            "title": "WAL Checkpoints",
            "targets": [
                {
                    "expr": "sum(rate(pg_stat_bgwriter_checkpoints_timed{instance=~\"$instance\"}[5m]))"
                }
            ]
        }
    ]
}